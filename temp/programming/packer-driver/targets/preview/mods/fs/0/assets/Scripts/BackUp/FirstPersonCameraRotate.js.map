{"version":3,"sources":["file:///Users/aleksandarbedov/Documents/CocosCreator/tajanstvenesobe2/assets/Scripts/BackUp/FirstPersonCameraRotate.ts"],"names":["_decorator","Component","math","macro","systemEvent","SystemEvent","game","view","setDisplayStats","ccclass","property","Vec2","Vec3","Quat","v2_1","v2_2","v3_1","qt_1","KEYCODE","W","charCodeAt","S","A","D","Q","E","SHIFT","KEY","shift","_pointerLockGeneral","FirstPersonCameraRotate","Boolean","slide","range","onLoad","on","EventType","MOUSE_MOVE","onMouseMove","MOUSE_DOWN","pointerLock","copy","_euler","node","eulerAngles","_position","position","onDestroy","off","update","dt","fromEuler","x","y","z","slerp","rotation","damp","setRotation","_pointerLockLocal","canvas","requestPointerLock","document","addEventListener","lockChangeAlert","pointerLockElement","console","log","e","_gotStartLocation","getLocation","getFrameSize","width","getDelta","rotateSpeed","degreesLocked"],"mappings":"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","sourcesContent":["\nimport { _decorator,\n    Component,\n    math, \n    macro,\n    Label,\n    systemEvent,\n    SystemEvent,\n    game,\n    view,\n    setDisplayStats,\n    sys,\n    Camera,\n    CameraComponent,\n    Node} from 'cc';\nconst { ccclass, property } = _decorator;\nconst { Vec2, Vec3, Quat } = math;\n\nconst v2_1 = new Vec2();\nconst v2_2 = new Vec2();\nconst v3_1 = new Vec3();\nconst qt_1 = new Quat();\nconst KEYCODE = {\n    W: 'W'.charCodeAt(0),\n    S: 'S'.charCodeAt(0),\n    A: 'A'.charCodeAt(0),\n    D: 'D'.charCodeAt(0),\n    Q: 'Q'.charCodeAt(0),\n    E: 'E'.charCodeAt(0),\n    SHIFT: macro.KEY.shift,\n}\n\nvar _pointerLockGeneral = false;\n\n@ccclass('FirstPersonCameraRotate')\nexport class FirstPersonCameraRotate extends Component {\n\n    @property(Boolean)\n    degreesLocked: Boolean = false;\n\n    //@property({type: Node})\n    //touchDisplay!: Node;\n \n\n\n    @property({ slide: true, range: [0.05, 0.5, 0.01] })\n    damp = 0.2;\n \n    @property\n    rotateSpeed = 1;\n\n    _gotStartLocation = false;\n\n    _pointerLockLocal = false;\n    _pointerLockPosition = new Vec3;\n \n    _euler = new Vec3();\n    _velocity = new Vec3();\n    _position = new Vec3();\n    _speedScale = 1;\n\n    onLoad() {\n        systemEvent.on(SystemEvent.EventType.MOUSE_MOVE, this.onMouseMove, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_DOWN, this.pointerLock, this);\n \n        Vec3.copy(this._euler, this.node.eulerAngles);\n        Vec3.copy(this._position, this.node.position);\n\n        setDisplayStats(false); // 关闭左下角显示FPS\n    }\n \n    onDestroy() {\n        systemEvent.off(SystemEvent.EventType.MOUSE_MOVE, this.onMouseMove, this);\n        systemEvent.off(SystemEvent.EventType.MOUSE_DOWN, this.pointerLock, this);\n    }\n \n    update(dt: number) {\n        Quat.fromEuler(qt_1, this._euler.x, this._euler.y, this._euler.z);\n        Quat.slerp(qt_1, this.node.rotation, qt_1, dt / this.damp);\n        \n        this.node.setRotation(qt_1);\n        \n        this._pointerLockLocal = _pointerLockGeneral;\n       // if(_pointerLockGeneral)\n       //      this.touchDisplay.active = false;\n       // else\n       //     this.touchDisplay.active = true;\n        \n    }\n \n    pointerLock() {\n\n        if ((game.canvas as HTMLCanvasElement).requestPointerLock)\n            (game.canvas as HTMLCanvasElement).requestPointerLock();\n\n        document.addEventListener('pointerlockchange', this.lockChangeAlert, false);\n        //document.addEventListener('mozpointerlockchange', this.lockChangeAlert, false);\n\n    }\n\n\n    lockChangeAlert() {\n        if (document.pointerLockElement === game.canvas ) {\n          console.log('The pointer lock status is now locked');\n          _pointerLockGeneral = true;\n          \n        } else {\n          console.log('The pointer lock status is now unlocked');\n          _pointerLockGeneral = false;\n        }\n    }\n\n    \n    onMouseMove(e: any) {\n            \n        if(!this._gotStartLocation) {\n            e.getLocation(v2_1);\n            this._gotStartLocation = true;\n        }\n        if(_pointerLockGeneral) {\n            //v2_1 = this._pointerLockPosition;\n            if (v2_1.x > view.getFrameSize().width * 0.4) { // rotation\n                e.getDelta(v2_2);\n                this._euler.y -= v2_2.x * this.rotateSpeed * 0.1;\n                this._euler.x += v2_2.y * this.rotateSpeed * 0.1;\n\n                if(this.degreesLocked) {\n                    if (this._euler.x <= -70) {\n                        this._euler.x = -70;\n                    }\n                    if (this._euler.x >= 45) {\n                        this._euler.x = 45;\n                    }\n                }\n\n                //console.log(this._euler);\n            }\n        }\n    }\n\n};"]}
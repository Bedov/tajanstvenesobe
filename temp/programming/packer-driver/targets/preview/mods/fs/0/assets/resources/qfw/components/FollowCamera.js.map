{"version":3,"sources":["file:///Users/aleksandarbedov/Documents/CocosCreator/tajanstvenesobe2/assets/resources/qfw/components/FollowCamera.ts"],"names":["_decorator","Component","Node","systemEvent","SystemEvent","EventMouse","Vec3","v3","Quat","quat","CameraComponent","ccclass","property","FollowCamera","type","inst","_inst","setFollowTarget","target","start","on","EventType","MOUSE_DOWN","onMouseDown","MOUSE_UP","onMouseUp","MOUSE_MOVE","onMouseMove","MOUSE_WHEEL","onMouseWheel","adjustCamera","lookDir","rotationEulers","euler","node","eulerAngles","clone","x","y","z","normalize","_lookDir","_lookUp","set","cross","_lookRight","fromAxes","_rotate","setRotation","multiplyScalar","_zoom","subtract","_cameraPos","camera","setPosition","event","getButton","BUTTON_RIGHT","_isMouseDown","deltaX","getUIDeltaX","deltaY","getUIDeltaY","rotate","rx","ry","angles","setRotationFromEuler","zoom","delta","_zoomSensitivty","_minZoom","_maxZoom","getScrollY","update","deltaTime","getPosition","_targetPos","add","lookAtOffset"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, sys, systemEvent, SystemEvent, EventMouse, Vec3, v3, Quat, quat, CameraComponent } from 'cc';\nconst { ccclass, property } = _decorator;\n\n@ccclass('FollowCamera')\nexport class FollowCamera extends Component {\n    /* class member could be defined like this */\n    // dummy = '';\n\n    /* use `property` decorator if your want the member to be serializable */\n    // @property\n    // serializableDummy = 0;\n    private static _inst: FollowCamera = null;\n    public static get inst(): FollowCamera {\n        return this._inst;\n    }\n\n    @property({ type: Node })\n    target: Node = null;\n\n    @property({ type: CameraComponent })\n    camera:CameraComponent = null;\n\n    @property({ type: Vec3 })\n    lookAtOffset: Vec3 = v3(0, 10, 0);\n\n    private _isMouseDown = false;\n    private _targetPos = v3(0, 0, 0);\n    private _cameraPos = v3(0, 0, 0);\n    private _lookDir = v3(0, 0, -1);\n    private _lookRight = v3(1, 0, 0);\n    private _lookUp = v3(0, 1, 0);\n    private _rotate = quat();\n    private _zoom = 4;\n    private _minZoom = 2;\n    private _maxZoom = 6;\n    private _zoomSensitivty = 0.02;\n\n    setFollowTarget(target: Node) {\n        this.target = target;\n    }\n\n    start() {\n        FollowCamera._inst = this;\n        // Your initialization goes here.\n        systemEvent.on(SystemEvent.EventType.MOUSE_DOWN, this.onMouseDown, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_UP, this.onMouseUp, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_MOVE, this.onMouseMove, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\n\n        //systemEvent.on(SystemEvent.EventType.TOUCH_START,this.onMouseDown,this);\n        //systemEvent.on(SystemEvent.EventType.TOUCH_START,this.onMouseDown,this);\n        //systemEvent.on(SystemEvent.EventType.TOUCH_START,this.onMouseDown,this);\n\n        this.adjustCamera();\n    }\n\n    public get lookDir(): Vec3 {\n        return this.lookDir;\n    }\n\n    public get rotationEulers(): Vec3 {\n        let euler = this.node.eulerAngles.clone();\n        euler.x *= -1;\n        euler.y *= -1;\n        euler.z *= -1;\n        return euler;\n    }\n\n    adjustCamera() {\n        if (!this.target) {\n            return;\n        }\n\n        Vec3.normalize(this._lookDir, this._lookDir);\n\n        this._lookUp.set(0, 1, 0);\n\n        //取右向量\n        Vec3.cross(this._lookRight, this._lookDir, this._lookUp);\n        Vec3.normalize(this._lookRight, this._lookRight);\n\n        //取得真实的UP向量\n        Vec3.cross(this._lookUp, this._lookRight, this._lookDir);\n        Vec3.normalize(this._lookUp, this._lookUp);\n\n        Quat.fromAxes(this._rotate, this._lookRight, this._lookUp, this._lookDir);\n        this.node.setRotation(this._rotate);\n\n\n        //从观察点开始，把摄相机往后推zoom距离\n        Vec3.multiplyScalar(this._lookDir, this._lookDir, this._zoom);\n        Vec3.subtract(this._cameraPos, v3(0, 0, 0), this._lookDir);\n        this.camera.node.setPosition(this._cameraPos);\n    }\n\n    onMouseDown(event: EventMouse) {\n        if(event.getButton() == EventMouse.BUTTON_RIGHT){\n            this._isMouseDown = true;\n        }\n    }\n\n    onMouseUp() {\n        this._isMouseDown = false;\n    }\n\n    onMouseMove(event: EventMouse) {\n        if (!this._isMouseDown) {\n            return;\n        }\n        let deltaX = event.getUIDeltaX() * 0.1;\n        let deltaY = event.getUIDeltaY() * 0.1;\n        this.rotate(deltaY,-deltaX);\n    }\n\n    rotate(rx:number,ry:number){\n        let angles = this.node.eulerAngles;\n        this.node.setRotationFromEuler(angles.x + rx, angles.y + ry, angles.z);\n    }\n\n    zoom(delta:number){\n        this._zoom += delta * this._zoomSensitivty;\n        if (this._zoom < this._minZoom) {\n            this._zoom = this._minZoom;\n        }\n        if (this._zoom > this._maxZoom) {\n            this._zoom = this._maxZoom;\n        }\n\n        //从观察点开始，把摄相机往后推zoom距离\n        Vec3.normalize(this._lookDir, this._lookDir);\n        Vec3.multiplyScalar(this._lookDir, this._lookDir, this._zoom);\n        Vec3.subtract(this._cameraPos, v3(0, 0, 0), this._lookDir);\n        this.camera.node.setPosition(this._cameraPos);\n    }\n\n\n    onMouseWheel(event: EventMouse) {\n        let delta = event.getScrollY() * this._zoomSensitivty;\n        this.zoom(delta);\n    }\n\n    update(deltaTime: number) {\n        // Your update function goes here.\n        if (this.target) {\n            this.target.getPosition(this._targetPos);\n            Vec3.add(this._targetPos, this._targetPos, this.lookAtOffset);\n            this.node.setPosition(this._targetPos);\n        }\n    }\n}\n"]}